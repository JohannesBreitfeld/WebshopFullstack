@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Webshop.Application.DTOs.UserDTOs
@using Webshop.Presentation.Auth
@inject IHttpClientFactory HttpClientFactory
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager Navigation

<EditForm Model="loginRequest" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <MudTextField InputType="InputType.Email" @bind-Value="loginRequest.Email" Label="Username" Required="true" />
    <MudTextField InputType="InputType.Password" @bind-Value="loginRequest.Password" Label="Password" Type="password" Required="true" />

    <MudButton ButtonType="ButtonType.Submit" OnClick="HandleLogin">Log in</MudButton>
</EditForm>

@code {
    private LoginUserRequest loginRequest = new LoginUserRequest();

    private async Task HandleLogin()
    {
        var client = HttpClientFactory.CreateClient("API");
        var response = await client.PostAsJsonAsync("api/auth/login", loginRequest);

        if (response.IsSuccessStatusCode)
        {
            var token = await response.Content.ReadAsStringAsync();
            await AuthStateProvider.MarkUserAsAuthenticated(token);
            Navigation.NavigateTo("/");
        }
        else
        {
            // Hantera fel
        }
    }
}